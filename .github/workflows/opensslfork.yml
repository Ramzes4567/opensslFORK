# –ò–º—è –¥–ª—è –Ω–∞—à–µ–≥–æ –≤–æ—Ä–∫—Ñ–ª–æ—É - –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ GitHub
name: OpenSSL Secret Scanner

# –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏
on:
    # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    workflow_dispatch:
jobs:
  find_secrets:
    name: Scan OpenSSL Code
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —É–±—É–Ω—Ç—É
    runs-on: ubuntu-latest
    
    steps:
    # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π OpenSSL
    - name: Clone OpenSSL
      uses: actions/checkout@v4
      with:
        repository: openssl/openssl
        fetch-depth: 0

    # –°—Ç–∞–≤–∏–º Trivy
    - name: Install Trivy
      run: |
        sudo apt update
        sudo apt install -y wget apt-transport-https
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt update
        sudo apt install -y trivy

    # –ì–ª–∞–≤–Ω—ã–π —à–∞–≥ - –∏—â–µ–º —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ
    - name: Scan for secrets
      run: |
        echo "üîç Starting secret scan..."
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        trivy fs --scanners secret . > scan_results.txt
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
        if grep -q "Total:" scan_results.txt; then
          echo "SECURITY ALERT: Secrets found in the codebase!"
          echo "Check the scan results for details."
          exit 1
        fi
      
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
    - name: Save Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: scan_results.txt
        retention-days: 5

    # –í—ã–≤–æ–¥–∏–º —Å–≤–æ–¥–∫—É
    - name: Show Summary
      if: always()
      run: |
        echo "=== Scan Summary ==="
        if [ -f scan_results.txt ]; then
          echo "Found secrets:"
          grep -A 5 "Total:" scan_results.txt || echo "No secrets found"
        else 
          echo "!!! Scan results file not found !!!"
        fi
